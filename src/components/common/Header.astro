---
import { Image } from "astro:assets";
import logo from "../../assets/branding/Kaap_RGB_Logo_rond_fc.svg";

interface Props {
  lang: string;
}

const { lang } = Astro.props;

import { useTranslations } from "../../i18n/utils";
const t = useTranslations(lang as any);

const navItems = [
  { 
    name: t('nav.facilities'), 
    href: `/${lang}/faciliteiten`,
    children: [
        { name: t('nav.facilities.labs'), href: `/${lang}/faciliteiten/testen-ontwikkelen` },
        { name: t('nav.facilities.housing'), href: `/${lang}/faciliteiten/huisvesting` },
        { name: t('nav.facilities.meeting'), href: `/${lang}/faciliteiten/vergaderruimtes` }
    ]
  },
  { name: t('nav.projects'), href: `/${lang}/projecten` },
  { 
    name: t('nav.audiences'), 
    href: `/${lang}/ondernemers`,
    children: [
        { name: t('nav.audiences.entrepreneurs'), href: `/${lang}/ondernemers` },
        { name: t('nav.audiences.education'), href: `/${lang}/onderwijs` },
        { name: t('nav.audiences.government'), href: `/${lang}/overheid` }
    ]
  },
  { 
    name: t('nav.about'), 
    href: `/${lang}/over`,
    children: [
        { name: t('nav.team'), href: `/${lang}/ons-team` },
        { name: t('nav.vacancies'), href: `/${lang}/vacatures` },
        { name: t('nav.news'), href: `/${lang}/nieuws` }
    ]
  }
];
---

<header
  class="fixed top-0 left-0 w-full z-50 transition-all duration-500 ease-in-out px-0 py-0"
  id="main-header"
>
  <div
    class="w-full transition-all duration-500 bg-white/90 backdrop-blur-md border border-transparent shadow-sm"
    id="header-container"
  >
    <div class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div
        class="grid grid-cols-[auto_1fr_auto] md:grid-cols-[200px_1fr_200px] items-center h-20 transition-all duration-300 px-4 sm:px-0"
        id="header-inner"
      >
        <!-- Logo -->
        <div class="flex justify-start items-center">
          <a href={`/${lang}/`} class="group block">
            <!-- Using the round logo as requested -->
            <img
              src={logo.src}
              alt="Innovatiepunt KAAP"
              class="h-12 w-auto transition-transform duration-300 group-hover:scale-110"
            />
          </a>
        </div>

        <!-- Desktop Nav -->
        <nav class="hidden md:flex justify-center gap-1 items-center">
            {navItems.map((item) => (
                item.children ? (
                    <div class="relative group">
                        <a href={item.href} class="px-5 py-2.5 text-sm font-bold text-gray-700 hover:text-kaap-purple hover:bg-gray-50/80 rounded-full transition-all flex items-center gap-1.5 whitespace-nowrap">
                            {item.name}
                            <svg class="w-3.5 h-3.5 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </a>
                        <!-- Dropdown -->
                        <div class="absolute left-1/2 -translate-x-1/2 mt-2 w-56 bg-white rounded-2xl shadow-xl border border-gray-100 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 transform scale-95 group-hover:scale-100 origin-top z-50 overflow-hidden">
                            <div class="p-2 space-y-1">
                                {item.children.map((child) => (
                                    <a href={child.href} class="block px-4 py-3 text-sm font-medium text-gray-700 hover:bg-gray-50 hover:text-kaap-purple rounded-xl transition-all">
                                        {child.name}
                                    </a>
                                ))}
                            </div>
                        </div>
                    </div>
                ) : (
                    <a href={item.href} class="px-5 py-2.5 text-sm font-bold text-gray-700 hover:text-kaap-purple hover:bg-gray-50/80 rounded-full transition-all whitespace-nowrap">
                        {item.name}
                    </a>
                )
            ))}
        </nav>

         <div class="hidden md:flex items-center justify-end gap-5">
            <!-- Language Switcher -->
            <div class="flex items-center text-xs font-black bg-gray-100/80 backdrop-blur-sm rounded-full p-1 border border-gray-200/50 shadow-inner">
                <a href="/nl" class={`px-3.5 py-2 rounded-full transition-all duration-300 ${lang === 'nl' ? 'bg-white text-kaap-purple shadow-sm ring-1 ring-black/5' : 'text-gray-400 hover:text-gray-600'}`}>NL</a>
                <a href="/en" class={`px-3.5 py-2 rounded-full transition-all duration-300 ${lang === 'en' ? 'bg-white text-kaap-purple shadow-sm ring-1 ring-black/5' : 'text-gray-400 hover:text-gray-600'}`}>EN</a>
            </div>
 
            <a
              href={`/${lang}/contact`}
              class="group relative inline-flex items-center justify-center px-6 py-2.5 text-white font-black text-xs transition-all hover:-translate-y-0.5 filter drop-shadow hover:drop-shadow-lg rounded-tl-xl rounded-br-xl overflow-hidden min-w-[140px] whitespace-nowrap"
            >
                <!-- Base Gradient Layer -->
                <div class="absolute inset-0 bg-kaap-gradient"></div>
                <!-- Hover Swipe Layer -->
                <div class="absolute inset-0 bg-kaap-purple transition-transform duration-500 ease-out origin-left transform scale-x-0 group-hover:scale-x-100"></div>
                <span class="relative z-10 inline-block uppercase tracking-wider">{t('cta.book')}</span>
            </a>
        </div>

        <!-- Mobile Menu Button -->
        <div class="md:hidden flex items-center">
          <button
            id="mobile-menu-btn"
            class="text-gray-700 hover:text-gray-900 focus:outline-none p-2 hover:bg-gray-100 transition-colors"
          >
            <span class="sr-only">Open main menu</span>
            <svg
              class="h-6 w-6"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div
    id="mobile-menu"
    class="hidden md:hidden bg-white/98 backdrop-blur-2xl border-t border-gray-100 absolute w-full left-0 z-40 shadow-2xl transition-all duration-300 ease-in-out"
  >
    <div class="px-4 py-6 space-y-4 max-h-[85vh] overflow-y-auto">
      {navItems.map((item, index) => (
        item.children ? (
             <div class="space-y-2 border-b border-gray-50 pb-4 last:border-0">
                <div class="flex items-center justify-between">
                    <a href={item.href} class="text-xl font-bold text-gray-900 active:text-kaap-purple">
                        {item.name}
                    </a>
                    <button 
                        class="p-2 -mr-2 text-gray-400 mobile-submenu-toggle transition-transform duration-300"
                        data-target={`submenu-${index}`}
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                </div>
                <div 
                    id={`submenu-${index}`}
                    class="hidden pl-4 space-y-3 pt-2 overflow-hidden transition-all duration-300 origin-top"
                >
                    {item.children.map(child => (
                         <a href={child.href} class="block text-base font-medium text-gray-500 active:text-kaap-purple py-1">
                            {child.name}
                        </a>
                    ))}
                </div>
             </div>
        ) : (
             <a href={item.href} class="block text-xl font-bold text-gray-900 active:text-kaap-purple border-b border-gray-50 pb-4 last:border-0">
                {item.name}
             </a>
        )
      ))}
      <a href={`/${lang}/contact`} class="block w-full text-center mt-6 px-5 py-4 rounded-tl-2xl rounded-br-2xl bg-kaap-gradient text-white font-black uppercase tracking-widest shadow-lg active:scale-95 transition-transform">
        {t('cta.book')}
      </a>
    </div>
  </div>
</header>

<script>
  const header = document.getElementById("main-header");
  const container = document.getElementById("header-container");
  const inner = document.getElementById("header-inner");
  const mobileBtn = document.getElementById("mobile-menu-btn");
  const mobileMenu = document.getElementById("mobile-menu");

  if (mobileBtn && mobileMenu) {
    mobileBtn.addEventListener("click", () => {
      mobileMenu.classList.toggle("hidden");
      // Reset all submenus when closing the main menu for a clean start next time
      if(mobileMenu.classList.contains('hidden')) {
        document.querySelectorAll('.mobile-submenu-toggle').forEach(t => {
            t.classList.remove('rotate-180');
        });
        document.querySelectorAll('[id^="submenu-"]').forEach(s => {
            s.classList.add('hidden');
        });
      }
    });
  }

  // Handle mobile sub-menu toggles
  document.querySelectorAll('.mobile-submenu-toggle').forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = btn.getAttribute('data-target');
        const submenu = document.getElementById(targetId);
        
        if (submenu) {
            const isHidden = submenu.classList.contains('hidden');
            
            // Toggle current
            submenu.classList.toggle('hidden');
            btn.classList.toggle('rotate-180');
        }
    });
  });

  // Scroll Effect
  const scrollThreshold = 50;

  window.addEventListener("scroll", () => {
    if (!header || !container || !inner) return;

    if (window.scrollY > scrollThreshold) {
      // Scrolled State: Compact but Sharp
      header.classList.add("px-0", "pt-0"); 
      container.classList.remove(
        "bg-white/0",
        "border-transparent"
      );
      container.classList.add(
        "bg-white/95",
        "shadow-md",
        "border-gray-200"
      );
      // Removed rounded-full and spacing to keep it sleek/sharp bar or minimal
      
      inner.classList.replace("h-20", "h-16"); // Smaller height
    } else {
      // Top State: Transparent/Full
      header.classList.remove("px-0", "pt-0");
      container.classList.remove("bg-white/95", "shadow-md", "border-gray-200");
      container.classList.add("bg-white/90", "border-transparent"); // keep semi-transparent initially or as per design
      
      inner.classList.replace("h-16", "h-20"); // Original height
    }
  });
</script>
