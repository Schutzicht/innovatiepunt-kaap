---
import { Image } from "astro:assets";
import beeldmerk from "../../assets/graphics/Beeldmerk_RGB_FC.png";
import mark from "../../assets/team/Marc.png";
import { useTranslations } from "../../i18n/utils";

const { lang = 'nl' } = Astro.params;
const t = useTranslations(lang as any);

const markLabel = {
  nl: { title: "Vraag het aan Mark", role: "Innovatiemanager" },
  en: { title: "Ask Mark", role: "Innovation Manager" }
};
const markTxt = markLabel[lang as 'nl' | 'en'] || markLabel.nl;
---

<!-- Mobile Subtle Floating Pill -->
<a 
    href={`/${lang}/contact`} 
    class="md:hidden fixed bottom-6 right-6 z-50 bg-white/90 backdrop-blur-xl border border-white/20 shadow-lg hover:shadow-xl active:scale-95 transition-all rounded-full px-5 py-3 flex items-center gap-2 group"
>
    <span class="text-kaap-purple font-bold text-sm uppercase tracking-wider">{t('cta.book')}</span>
    <svg class="w-4 h-4 text-kaap-purple group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
</a>

<!-- Desktop Floating Button -->
<a
  id="sticky-cta-desktop"
  href={`/${lang}/contact`}
  class="hidden md:flex fixed bottom-8 right-8 z-40 group items-center justify-center w-20 h-20 transition-transform duration-300 hover:scale-110 text-white"
>
  <!-- Beeldmerk Graphic Container - Spins 360deg on hover -->
  <div
    class="absolute inset-0 w-full h-full transition-transform duration-700 ease-in-out group-hover:rotate-180"
  >
    <Image
      src={beeldmerk}
      alt="Contact"
      class="w-full h-full object-contain drop-shadow-xl"
    />
  </div>

  <!-- Icon Container -->
  <div
    class="relative z-10 w-8 h-8 flex items-center justify-center pointer-events-none"
  >
    <!-- Icon (Message/Chat) -->
    <svg
      class="sticky-icon absolute inset-0 w-full h-full drop-shadow-md transition-all duration-300 ease-in-out transform group-hover:opacity-0 group-hover:scale-50 text-white"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
      ></path>
    </svg>

    <!-- Icon (Arrow Right) -->
    <svg
      class="sticky-icon absolute inset-0 w-full h-full drop-shadow-md opacity-0 scale-50 transition-all duration-300 ease-in-out transform group-hover:opacity-100 group-hover:scale-100 text-white"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
    </svg>
  </div>

  <!-- 'Mark' Pop-up Bubble -->
  <div class="absolute right-full mr-6 flex items-center transition-all duration-500 opacity-0 translate-x-8 pointer-events-none group-hover:opacity-100 group-hover:translate-x-0 group-hover:pointer-events-auto">
      <div class="bg-white/95 backdrop-blur-xl border border-white/20 shadow-[0_8px_30px_rgb(0,0,0,0.12)] rounded-2xl p-4 pr-6 flex items-center gap-4 whitespace-nowrap relative">
          <!-- Triangle pointer -->
          <div class="absolute top-1/2 -right-2 w-4 h-4 bg-white/95 transform -translate-y-1/2 rotate-45 border-r border-t border-white/20"></div>
          
          <div class="w-14 h-14 rounded-full overflow-hidden border-2 border-kaap-purple shadow-md shrink-0">
              <Image src={mark} alt="Mark" class="w-full h-full object-cover" />
          </div>
          <div class="text-left">
              <p class="text-xs text-kaap-purple font-bold uppercase tracking-wider mb-0.5">{markLabel.nl.title}</p>
              <p class="text-gray-600 text-sm font-medium">{markLabel.nl.role}</p>
          </div>
      </div>
  </div>
</a>

<script>
  const stickyCTA = document.getElementById("sticky-cta-desktop");

  function checkContrast() {
    if (!stickyCTA) return;

    // Get button center position
    const rect = stickyCTA.getBoundingClientRect();
    const x = rect.left + rect.width / 2;
    const y = rect.top + rect.height / 2;

    // Find elements under the button
    const elements = document.elementsFromPoint(x, y);

    // Find the first section with a data-theme attribute
    // We look for the closest section in the stack of elements under the point
    const themeSection = elements
      .find((el) => el.closest("section[data-theme]"))
      ?.closest("section[data-theme]");

    if (themeSection) {
      const theme = themeSection.getAttribute("data-theme");
      if (theme === "light") {
        updateIcons("text-kaap-gray");
      } else {
        updateIcons("text-white");
      }
    }
  }

  function updateIcons(colorClass: string) {
    if (!stickyCTA) return;
    const icons = stickyCTA.querySelectorAll(".sticky-icon");
    icons.forEach((icon) => {
      // Check if already has class to avoid thrashing
      if (!icon.classList.contains(colorClass)) {
        icon.classList.remove("text-white", "text-kaap-gray");
        icon.classList.add(colorClass);
      }
    });
  }

  // Check on scroll and resize
  window.addEventListener("scroll", checkContrast, { passive: true });
  window.addEventListener("resize", checkContrast, { passive: true });

  // Initial check
  checkContrast();
</script>
