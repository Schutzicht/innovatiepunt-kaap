---
import { Image } from "astro:assets";
import beeldmerk from "../../assets/graphics/Beeldmerk_RGB_FC.png";
import mark from "../../assets/team/Marc.png";
import { useTranslations } from "../../i18n/utils";

const { lang = 'nl' } = Astro.params;
const t = useTranslations(lang as any);

const markLabel = {
  nl: { title: "Vraag het aan Marc", role: "Innovatiemanager", mobile: "Vraag Marc" },
  en: { title: "Ask Marc", role: "Innovation Manager", mobile: "Ask Marc" }
};
const markTxt = markLabel[lang as 'nl' | 'en'] || markLabel.nl;
---

<!-- Mobile Subtle Floating Pill -->
<a 
    id="sticky-pill-mobile"
    href="tel:+31652661475"
    class="md:hidden fixed bottom-6 right-6 z-50 bg-white/95 backdrop-blur-xl border border-white/20 shadow-lg hover:shadow-xl active:scale-95 transition-all duration-500 rounded-full pl-2 pr-5 py-2 flex items-center gap-3 group opacity-0 translate-y-10 pointer-events-none"
>
    <div class="w-8 h-8 rounded-full overflow-hidden border border-kaap-purple shadow-sm">
        <Image src={mark} alt="Mark" class="w-full h-full object-cover" />
    </div>
    <span class="text-kaap-purple font-bold text-sm uppercase tracking-wider">{markTxt.mobile}</span>
</a>

<!-- Desktop Floating Button -->
<a
  id="sticky-cta-desktop"
  href="tel:+31652661475"
  class="hidden md:flex fixed bottom-8 right-8 z-40 group items-center justify-center w-20 h-20 transition-all duration-500 hover:scale-110 text-white"
>
  <!-- Beeldmerk Graphic Container - Spins 360deg on hover -->
  <div
    class="absolute inset-0 w-full h-full transition-transform duration-700 ease-in-out group-hover:rotate-180"
  >
    <Image
      src={beeldmerk}
      alt="Contact"
      class="w-full h-full object-contain drop-shadow-xl"
    />
  </div>

  <!-- Icon Container -->
  <div
    class="relative z-10 w-8 h-8 flex items-center justify-center pointer-events-none transition-transform duration-500 ease-[cubic-bezier(0.34,1.56,0.64,1)] group-hover:rotate-90"
  >
    <!-- Icon (Message/Chat) -->
    <svg
      class="sticky-icon absolute inset-0 w-full h-full drop-shadow-md transition-all duration-300 ease-in-out transform group-hover:opacity-0 group-hover:scale-50 text-white"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
      ></path>
    </svg>

    <!-- Icon (Lambda - Revolving) -->
    <div
      class="sticky-icon absolute inset-0 w-full h-full flex items-center justify-center drop-shadow-md opacity-0 scale-50 transition-all duration-300 ease-in-out transform group-hover:opacity-100 group-hover:scale-100"
    >
      <span class="text-white font-bold text-3xl leading-none pb-1">Î›</span>
    </div>
  </div>

  <!-- 'Mark' Pop-up Bubble -->
  <div class="absolute right-full mr-6 flex items-center transition-all duration-500 opacity-0 translate-x-8 pointer-events-none group-hover:opacity-100 group-hover:translate-x-0 group-hover:pointer-events-auto">
      <div class="bg-white/95 backdrop-blur-xl border border-white/20 shadow-[0_8px_30px_rgb(0,0,0,0.12)] rounded-2xl p-4 pr-6 flex items-center gap-4 whitespace-nowrap relative">
          <!-- Triangle pointer -->
          <div class="absolute top-1/2 -right-2 w-4 h-4 bg-white/95 transform -translate-y-1/2 rotate-45 border-r border-t border-white/20"></div>
          
          <div class="w-14 h-14 rounded-full overflow-hidden border-2 border-kaap-purple shadow-md shrink-0">
              <Image src={mark} alt="Mark" class="w-full h-full object-cover" />
          </div>
          <div class="text-left">
              <p class="text-xs text-kaap-purple font-bold uppercase tracking-wider mb-0.5">{markLabel.nl.title}</p>
              <p class="text-gray-600 text-sm font-medium">{markLabel.nl.role}</p>
          </div>
      </div>
  </div>
</a>

<script>
  const stickyDesktop = document.getElementById("sticky-cta-desktop");
  const stickyMobile = document.getElementById("sticky-pill-mobile");

  // Scroll Visibility Logic
  function checkScroll() {
      const scrollPos = window.scrollY;
      const threshold = window.innerHeight * 0.5; // Show after scrolling 50% of viewport

      // Mobile: Only show after scroll
      if (scrollPos > threshold) {
          stickyMobile?.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
      } else {
          stickyMobile?.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
      }
  }

  function checkContrast() {
    if (!stickyDesktop) return;

    // Get button center position
    const rect = stickyDesktop.getBoundingClientRect();
    const x = rect.left + rect.width / 2;
    const y = rect.top + rect.height / 2;

    // Find elements under the button
    const elements = document.elementsFromPoint(x, y);

    // Find the first section with a data-theme attribute
    // We look for the closest section in the stack of elements under the point
    const themeSection = elements
      .find((el) => el.closest("section[data-theme]"))
      ?.closest("section[data-theme]");

    if (themeSection) {
      const theme = themeSection.getAttribute("data-theme");
      if (theme === "light") {
        updateIcons("text-kaap-gray");
      } else {
        updateIcons("text-white");
      }
    }
  }

  function updateIcons(colorClass: string) {
    if (!stickyDesktop) return;
    const icons = stickyDesktop.querySelectorAll(".sticky-icon");
    icons.forEach((icon) => {
      // Check if already has class to avoid thrashing
      if (!icon.classList.contains(colorClass)) {
        icon.classList.remove("text-white", "text-kaap-gray");
        icon.classList.add(colorClass);
      }
    });
  }

  // Check on scroll and resize
  window.addEventListener("scroll", () => {
      checkScroll();
      checkContrast();
  }, { passive: true });
  
  window.addEventListener("resize", () => {
      checkScroll();
      checkContrast();
  }, { passive: true });

  // Initial check
  checkScroll();
  checkContrast();
</script>
